<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CookItUp! View Fridge</title>
    <style>
        h2 { text-align: center; font-weight: bold; color: black }
        body {
            background-color: pink
        }

        header {
            text-align: center
        }
    </style>
</head>
<body>
<script src="..\..\header.js"></script>
<nav>
    <article id="article">
        <h2>Fridge</h2>
        <h3>Ingredients</h3>
        <ul id="ingredients"></ul>

        <section id="section" hidden>

            <button id="button_delete_ingredient" onclick="deleteIngredients()">Delete an ingredient</button>
            <button id="done_deleting_ingredients" onclick="doneDeleteIngredients()" hidden>Done</button>

            <hr>

            <input id="searchIngredient" name="name" type="search"/>
            <button onclick="searchIngredient()">Add an ingredient</button>
            <p id="message_ingredient"></p>

            <hr>

            <form>
                <button type="button" onclick="searchRecipes()">Search</button>
            </form>

        </section>


    </article>
</nav>
<script src="..\..\footer.js"></script>
<script>

    let id_user = -1;
    let ingredientsList = document.getElementById("ingredients");

    let url = "/user/current";
    fetch(url).then(response => {
        return response.json();
    }).then(json => {
        id_user = json.id;
        url = "get";
        return fetch(url);
    }).then(response => {
        return response.json();
    }).then(json => {
        if (json.id == id_user) {
            document.getElementById("section").hidden = false;
        }
            //Ingedients

            let urlingredient = "fridge_ingredients";
            fetch(urlingredient).then(response => {
                return response.json();
            }).then(json => {
                let ingredients = json;
                for (let i = 0; i < ingredients.length; i++) {
                    addIngredient(ingredients[i]);
                }
            });


    });


</script>
<script>

    /**
     * Ingredients functions
     */
    function searchIngredient() {
        let ingredient = document.getElementById("searchIngredient").value;
        let ingredients = ingredientsList.childNodes;
        let found = false;
        for (let i = 0; i < ingredients.length && !found; i++) {
            if (ingredients[i].childNodes[0].textContent.toLowerCase() ==
                ingredient.toLocaleString().toLowerCase()) {
                found = true;
            }
        }
        if (!found) {

            document.getElementById("message_ingredient").textContent = "The ingredient has been added";
            url = "add_fridge_ingredient?ing=" + ingredient;
            fetch(url).then(response => {
                return response.json();
            }).then(json => {
                console.log(json);
                addIngredient(json);
            }).catch( error => {
                document.getElementById("message_ingredient").textContent = "This ingredient is not in our database, you cannot add it"
            });

            return true;
        } else {
            document.getElementById("message_ingredient").textContent = "The ingredient is already in the fridge";
        }
        return false;
    }

    function addIngredient(ingredient) {
        let li = document.createElement("li");
        li.textContent = ingredient.name;
        console.log(ingredient.name);
        li.id = "ingredient" + ingredient.id;
        let button = document.createElement("button");
        button.textContent = "Delete ingredient";
        button.hidden = true;
        button.name = "ingredient_button";
        button.onclick = ev => deleteIngredient(ingredient.id);
        li.appendChild(document.createElement("br"));
        li.appendChild(button);

        ingredientsList.appendChild(li);
    }

    function deleteIngredients() {
        let buttons = document.getElementsByName("ingredient_button");
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].hidden = false;
        }
        document.getElementById("button_delete_ingredient").hidden = true;
        document.getElementById("done_deleting_ingredients").hidden = false;
    }

    function doneDeleteIngredients() {
        let buttons = document.getElementsByName("ingredient_button");
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].hidden = true;
        }
        document.getElementById("button_delete_ingredient").hidden = false;
        document.getElementById("done_deleting_ingredients").hidden = true;
    }

    function deleteIngredient(id) {
        let url = "delete_fridge_ingredient?idIng=" + id;
        fetch(url).then(response => {
            return response.text();
        }).then(text => {
            document.getElementById("ingredients").removeChild(
                document.getElementById("ingredient" + id));
        });
    }

    function searchRecipes() {
        let url = "filter_fridge_ingredient";
        fetch(url).then(response => {
            return response.json();
        }).then(json => {
            let article = document.getElementById("article");
            let search = document.getElementById("search");
            if (search != null) {
                article.removeChild(search);
            }
            search = document.createElement("div");
            search.id = "search";
            for (let i = 0; i < json.length; i++) {
                let section = document.createElement("section");

                //create the title
                let link = document.createElement("a");
                link.href = "/recipe/" + json[i].id + "/view.html";
                let title = document.createElement("h2");
                title.textContent = json[i].name;
                link.appendChild(title);
                section.appendChild(link);

                //create the title for the ingredients
                let ingredientsTitle = document.createElement("h3");
                ingredientsTitle.textContent = "Ingredients";
                section.appendChild(ingredientsTitle);
                //create the list for the ingredients
                let ingredientsList = document.createElement("ul");
                let ingredients = json[i]["ingredients"];
                for (let j = 0; j < ingredients.length; j++) {
                    let li = document.createElement("li");
                    li.textContent = ingredients[j].name;
                    ingredientsList.appendChild(li);
                }
                section.appendChild(ingredientsList);

                //create the title for the steps
                let stepsTitle = document.createElement("h3");
                stepsTitle.textContent = "Steps";
                section.appendChild(stepsTitle);
                //create the list for the steps
                let stepsList = document.createElement("ol");
                let steps = json[i]["steps"];
                for (let j = 0; j < steps.length; j++) {
                    let li = document.createElement("li");
                    li.textContent = steps[j].title;
                    stepsList.appendChild(li);
                }
                section.appendChild(stepsList);

                search.appendChild(section);
                search.appendChild(document.createElement("hr"));
            }
            article.appendChild(search);
        });
    }
</script>
</body>
</html>