<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script src="..\..\header.js"></script>
<nav>
    <article>
        <h3>Ingredients</h3>
        <ul id = "ingredients"></ul>

        <section id="section" hidden>

            <button id="button_delete_ingredient" onclick="deleteIngredients()">Delete an ingredient</button>
            <button id="done_deleting_ingredients" onclick="doneDeleteIngredients()" hidden>Done</button>

            <hr>

            <input id = "searchIngredient" name = "name" type = "search"/>
            <button onclick="searchIngredient()">Add an ingredient</button>
            <p id = "message_ingredient"></p>

        </section>


    </article>
</nav>
<script src="..\..\footer.js"></script>
<script>

    let id_user = -1;
    let ingredientsList = document.getElementById("ingredients");
    console.log(ingredientsList);
    let url = "/user/current";
    fetch(url).then( response => {
        return response.json();
    }).then( json => {
        id_user = json.id;
        url = "get";
        return fetch(url);
    }).then( response => {
        const jsonPromise = response.json();
        jsonPromise.then(json => {
            console.log(json.id);
            console.log(id_user);
            if (json.id == id_user) {
                document.getElementById("section").hidden = false;
            }
            else {
                //Ingedients

                let urlingredient = "fridge_ingredients";
                fetch(urlingredient).then(response => {
                    return response.json();
                }).then (json => {
                    let ingredients = json;
                    for(let i = 0; i < ingredients.length; i++) {
                        addIngredient(ingredients[i]);
                    }
                });
            }
        });
    });



</script>
<script>

    /**
     * Ingredients functions
     */
    function searchIngredient() {
        let ingredient = document.getElementById("searchIngredient").value;
        let ingredients = ingredientsList.childNodes;
        let found = false;
        for(let i = 0; i < ingredients.length && !found; i++) {
            if (ingredients[i].childNodes[0].textContent.toLowerCase() ==
                ingredient.toLocaleString().toLowerCase()) {
                found = true;
            }
        }
        if(!found) {

            document.getElementById("message_ingredient").textContent = "The ingredient has been added";
            url = "add_fridge_ingredient?ing="+ingredient;
            fetch(url).then( response => {
               return response.json();
            }).then( json => {
                console.log(json);
                addIngredient(json);
            });

            return true;
        }
        else {
            document.getElementById("message_ingredient").textContent = "The ingredient is already in the fridge";
        }
        return false;
    }

    function addIngredient(ingredient) {
        let li = document.createElement("li");
        li.textContent = ingredient.name;
        console.log(ingredient.name);
        li.id = "ingredient"+ingredient.id;
        let button = document.createElement("button");
        button.textContent = "Delete ingredient";
        button.hidden = true;
        button.name = "ingredient_button";
        button.onclick = ev => deleteIngredient(ingredient.id);
        li.appendChild(document.createElement("br"));
        li.appendChild(button);

        ingredientsList.appendChild(li);
    }

    function deleteIngredients() {
        let buttons = document.getElementsByName("ingredient_button");
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].hidden = false;
        }
        document.getElementById("button_delete_ingredient").hidden = true;
        document.getElementById("done_deleting_ingredients").hidden = false;
    }

    function doneDeleteIngredients() {
        let buttons = document.getElementsByName("ingredient_button");
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].hidden = true;
        }
        document.getElementById("button_delete_ingredient").hidden = false;
        document.getElementById("done_deleting_ingredients").hidden = true;
    }

    function deleteIngredient(id) {
        let url = "delete_fridge_ingredient?idIng=" + id;
        fetch(url).then(response => {
            return response.text();
        }).then(text => {
            document.getElementById("ingredients").removeChild(
                document.getElementById("ingredient" + id));
        });
    }
</script>
</body>
</html>