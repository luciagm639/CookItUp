<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Modify a recipe</title>
</head>
<body>
    <script src="..\..\header.js"></script>
    <nav>
        <article>
            <h2 id = "recipe_name"></h2>
            <selection id="selection" hidden>

            <h3>Ingredients</h3>
            <ul id = "ingredients"></ul>
            <button id="button_delete_ingredient" onclick="deleteIngredient()">Delete an ingredient</button>
            <button id="done_deleting_ingredients" onclick="doneDeleteIngredient()" hidden>Done</button>

            <hr>

            <input id = "searchIngredient" name = "name" type = "search"/>
            <button onclick="searchIngredient()">Add an ingredient</button>
            <p id = "message_ingredient"></p>

            <h3>Steps</h3>
            <ol id = "steps"></ol>


            <p><button id="step_button" onclick="addStep1()">Add step</button></p>
            <div id="step" hidden>
                <p>Title: <input id="title" type="text"/></p>
                <p>Number of minutes: <input id="minutes" type="number"/></p>
                <p>Description: <textarea id="description" rows="3" cols="50"></textarea></p>
                <p><button onclick="addStep2()">Add step</button></p>
            </div>

            </selection>
        </article>
    </nav>
    <script src="..\..\footer.js"></script>
    <script>

        let id_user = -1;
        let url = "/user/current";
        fetch(url).then( response => {
            return response.json();
        }).then( json => {
            console.log(json);
            id_user = json.id;
        });

        url = "get";
        fetch(url).then( response => {
            const jsonPromise = response.json();
            jsonPromise.then(json => {
                if (json["author"]["id"] != id_user) {
                    let error = document.getElementById("recipe_name");
                    error.textContent = "You cannot edit this recipe because you are not its author";
                }
                else {
                    document.getElementById("selection").hidden = false;
                    let name_recipe = document.getElementById("recipe_name");
                    name_recipe.textContent = json["name"];

                    let ingredientsList = document.getElementById("ingredients");
                    let ingredients = json["ingredients"];
                    for(let i = 0; i < ingredients.length; i++) {
                        let li = document.createElement("li");
                        li.textContent = ingredients[i].name;
                        ingredientsList.appendChild(li);
                        let button = document.createElement("button");
                        button.textContent = "Delete ingredient"
                        button.hidden = true;
                        button.name = "ingredient_button";
                        li.appendChild(document.createElement("br"))
                        li.appendChild(button);
                    }

                    //Steps
                    let stepsList = document.getElementById("steps");
                    let steps = json["steps"];
                    for(let i = 0; i < steps.length; i++) {
                        let li = document.createElement("li");
                        //title
                        let stepTitle = document.createElement("strong");
                        stepTitle.textContent = steps[i].title;
                        li.appendChild(stepTitle);

                        li.appendChild(document.createElement("br"));

                        //minutes
                        let minutes = document.createElement("small");
                        minutes.textContent = steps[i]["numberOfMinutes"] + " minutes";
                        li.appendChild(minutes)

                        //description
                        if (steps[i]["description"] != "") {
                            li.appendChild(document.createElement("br"));
                            li.appendChild(document.createTextNode(steps[i]["description"]));
                        }

                        stepsList.appendChild(li);
                    }
                }

            });
        });



    </script>
    <script>
        function searchIngredient() {
            let ingredient = document.getElementById("searchIngredient").value;
            let ingredients = document.getElementById("ingredients");
            let ingredientsChildNodes = ingredients.childNodes;
            let found = false;
            for(var i = 0; i < ingredientsChildNodes.length && !found; i++) {
                if (ingredientsChildNodes[i].textContent == ingredient) {
                    found = true;
                }
            }
            if(!found) {
                let listElement = document.createElement('li');
                listElement.appendChild(document.createTextNode(ingredient));
                ingredients.appendChild(listElement);
                document.getElementById("message_ingredient").textContent = "The ingredient has been added";
                url = "add_ingredient?name="+ingredient;
                fetch(url).then( response => {
                    return response.json();
                }).then( json => {
                    console.log(json);
                });

                return true;
            }
            else {
                document.getElementById("message_ingredient").textContent = "The ingredient is already in the recipe";
            }
            return false;
        }

        function addStep1() {
            document.getElementById("step").hidden = false;
            document.getElementById("step_button").hidden = true;
        }

        function addStep2() {
            let title = document.getElementById("title").value;
            let minutes = document.getElementById("minutes").value;
            let description = document.getElementById("description").value;
            if (title == "" || minutes == "") {
                alert("You have left required fields unresponded");
                return;
            }
            let stepsList = document.getElementById("steps");
            let li = document.createElement("li");
            //title
            let stepTitle = document.createElement("strong");
            stepTitle.textContent = title;
            li.appendChild(stepTitle);

            li.appendChild(document.createElement("br"));

            //minutes
            let minutes1 = document.createElement("small");
            minutes1.textContent = minutes + " minutes";
            li.appendChild(minutes1);

            url = "add_step?" +
                "title="+title
                +"&numberOfMinutes="+minutes;
            if (description != "") {
                url += "&description="+description;
                li.appendChild(document.createElement("br"));
                li.appendChild(document.createTextNode(description));
            }
            stepsList.appendChild(li);

            fetch(url).then( response => {
                return response.json();
            }).then( json => {
                console.log(json);
            });
        }

        function deleteIngredient() {
            let buttons = document.getElementsByName("ingredient_button");
            for (let i = 0; i < buttons.length; i++) {
                buttons[i].hidden = false;
            }
            document.getElementById("button_delete_ingredient").hidden = true;
            document.getElementById("done_deleting_ingredients").hidden = false;
        }

        function doneDeleteIngredient() {
            let buttons = document.getElementsByName("ingredient_button");
            for (let i = 0; i < buttons.length; i++) {
                buttons[i].hidden = true;
            }
            document.getElementById("button_delete_ingredient").hidden = false;
            document.getElementById("done_deleting_ingredients").hidden = true;
        }
    </script>
</body>
</html>